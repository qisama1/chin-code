# 3PC(3 phase commit) 三阶段提交

三阶段提交是想要来改善2PC的问题的。看看它的逻辑：

## 处理过程

### CanCommit
第一阶段先给每个参与者发送CanCommit消息，这一阶段就做一个简单的收集，如果有节点回复的NO，那么就不能进行下去，给客户端回复失败。

### PreCommit
如果此时收到了所有参与者的Yes，那么就进行下一步的PreCommit

这一步就是让参与者进行操作，并且记录下undo和redo日志。

特点来了，如果此时有任何一个节点发送了NO，那么协调者会立刻叫停，让所有节点中断事务。同时如果超过一段时间没有收到协调者的信息，也会中断事务。此时就有优势了，可以解决当协调者挂掉了以后的数据不一致。

如果收到了所有的YES，那么就进入下一阶段

### DoCommit
这一阶段就是和之前的2PC一样，让各个参与者去真正的提交事务。

同时，如果有任何一个节点发送了NO，那也会立刻叫停并回滚各个参与者的事务。

## 缺点

同样也是有一致性问题的，如果协调者在commit以后与其他节点出现了断联， 其他节点进行了回滚，他并不知道自己的数据是与其他节点不一致的。