# redo log和脏页刷新时机

为什么你的数据库有时候会抖一下？
这个抖一下也就是因为脏页的刷新，就相当于客栈老板脑子不够用了，只能等着把脏页刷新以后把账本同步一下。
那其实脏页的刷新也和redo log相关，所以我们把他两一起讨论一下。

## redo log的刷新
总所周知，redo log不同于binlog，它是循环写的，那么redo log默认大小4G（4个1G的文件）必然会有满掉的时候，这时候就会触发check point进行脏页的刷新。
具体而言看看 redo log什么时候刷新

1. 专门的线程负责1s定时的redo log的刷盘
2. 当redo log不够用的时候，触发check point，把redo log的部分写入磁盘，同时进行脏页的回写。
3. 事务提交时，redo log需要刷新到内存中去。

此时我有个顿悟，日志和数据其实都是在磁盘中的，内存始终只是一个中间态。那么脏页不管事务提交不提交它都是可以在内存，也可以在磁盘中的，当如果事务提交的时候必须刷回磁盘，当事务回滚的时候undo log回滚。不一定说事务未提交的数据就一定在内存中。总而言之，事务的原子性，持久性，一致性，隔离性并不是不是由事务提不提交来保证，而是redo log和undo log他们这些日志来保证。

## 脏页的刷新时机
缓冲池的页有下面几种状态：
1. 从未使用（由于LRU机制，它很容易被淘汰掉
2. 被使用过
3. 已经被修改成为了脏页

脏页的意思可以理解为：目前内存中和磁盘中的数据是不同步的。
那么脏页肯定是需要被同步会磁盘的，为了效率，不可能是一有脏页我们就刷新进磁盘。所以这就有关一个数据一致性和效率的拉扯了。看看innodb提供的选项吧。
❑Sharp Checkpoint -全量
❑Fuzzy Checkpoint -增量
那么在数据库关闭的时候，应该是要使用全量的刷新。为了效率一般情况下使用增量的刷新。

### 脏页的刷新时机
1. 脏页被LRU列表踢出，这时候没办法，就必须要进行脏页的刷回了
2. 每秒一次的脏页的刷回
3. redo log写满。