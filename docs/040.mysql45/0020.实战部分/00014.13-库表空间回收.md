# 库表空间回收
在innodb里面 当删除数据的时候 并不会直接将空间给释放，而是会把对应的页标记为可复用。

## 表文件
表空间是可以处于共享空间中，也可以是单独的文件空间的，所以参数可选。
innodb_file_per_table 控制的
1. 这个参数设置为 OFF 表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；
2. 这个参数设置为 ON 表示的是，每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。

那么当使用OFF这个参数的时候，当你drop table的时候都不会把空间回收。而使用ON的时候就会把空间给回收了

## 表中的空洞
1. 我们的delete操作并不会真正的把表空间回收，而是把对应的空间标记为可用，所以会产生空洞的时候
2. 当我们insert的时候，如果不是按顺序插入，那么就会导致页分裂，页分裂的话就会自然而然的导致空洞。
这些空洞就会导致我们表的占用空间变大，利用率低。

## 解决问题

### 重建表
如之前讲的时候，我们重新建表，把数据按序插入，就可以有效的避免页分裂，提高页的利用率。

下面这个命令就可以实现自动的新建表和表的转化
```sql
alter table A engine=InnoDB; 
```

### Online DDL
在Mysql5.6以后支持Online DDL，回忆一下哈，先上MDL写锁，在转化为MDL读锁，这里是保证同时只能有一个事务对表结构进行修改， 这里是最耗时的时间，同时这时的增删改查都是不会被阻塞的，看起来就像是online的，在最后改回原表的时候需要上写锁，然后再释放锁。
