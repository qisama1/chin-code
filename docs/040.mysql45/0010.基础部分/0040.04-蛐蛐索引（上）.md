# 04-蛐蛐索引（上）

> 看书的时候需要目录去快速寻找感兴趣的内容，而索引就是数据库的目录

## 关于索引的数据结构选型

索引可选的数据结构也挺多的，例如哈希索引，有序列表索引，B树索引，B+树索引，我们一一道来。

### 哈希索引

程序员们都知道，遇事不决就哈希。这是一种最最常见的用空间去换时间的选择。那让我们来看看他的优势和弊端。

优势：
- 哈希索引在无冲突的情况下可以做到O(1)的超快读取数据
- 简单、易于理解。

劣势：
- 哈希索引一旦冲突到达一定级别，它的查找时间是极不稳定的，甚至趋近于O(n)。而作为一个数据库系统，我们希望系统的处理的较为稳定的，不能说一类用户1ms就能返回结果另一类却要他十倍甚至百倍的时间。
- 它无法做到范围查找和模糊查找。

#### 哈希索引适用的场景

十分明确：数据量不大的等值查询；如果只需要等值查询且数据量不大的情况下，哈希索引就是最优秀的索引。

其实在Innodb中也有哈希索引的影子（自适应哈希 这是对数据库的一种提升，当对以where a = xxx的这种形式对某一个页访问次数超过n/16,n表示总页数，会将其单独拉出来建立一个哈希索引）

### 有序列表索引

有序列表索引也无须分辨它的优劣势了，它有它特殊的适用场景-静态数据的范围查找。

由于是有序排列，想要得到一个值所在的位置只需要二分查找即可。那么即可找到此值再顺序找下去即可。

劣势：
- 难以维护

这一点就注定它无法当成Innodb的索引结构。因为我们知道对于有序列表的增删，复杂度都是O(n)的，这当然是难以接受的。

#### 有序列表适用场景

静态（无更新），范围查找频繁场景。


### B树

B树同时也是多叉平衡树查找树，有着优秀的查找能力，较为强悍的维护能力，多数情况都可以通过简单旋转去维护。

优势：
- 有序，支持范围查找和模糊查找。
- 快速查找，多叉平衡查找树可以支持log2(n)的复杂度。
- 易于维护，树状结构，大多数通过简单选择即可维护。

这里先不谈B树的劣势，我们直接讨论B+树的优势

### B+树

B+树可以称之为B树的变种，它利用了更多的空间去存储指针，把所有真实的数据节点放在了叶子节点层，在叶子节点层做出了一个双向链表结构。那么它势必基于B树之上带来了这样的优势：

- 更加扁平，除叶子节点外的节点不再存数据了，使得一层能够容纳更多的信息。
- 更便于有序查找，直接在叶子节点层就相当于维护了一个有序列表。
- 及其稳定的查询速度，因为每个数据（也就是叶子节点），都处于同一高度，所以查询速度及其稳定。

劣势：
- 可能相当于B树的劣势就是用到了更多的存储空间，空间换时间，但是这一般都是可以容忍的。

## 索引的维护

好了，对比完了上面的这些数据结构，我也一直持有每个数据结构都有其最适合的场景的这种态度。那么对于Innodb这种数据场景，毫无疑问B+树就是最优的。

建立完了索引，我们也要知道它是怎么维护索引的，这样才能对其进行某种意义上的优化。

### B+树的节点分裂
在Innodb中，B+树的叶子节点存放的是数据页，非叶子节点存放的是节点的指针，那么当一个数据页中存放的数据爆满了，那么就不得不进行分裂，将页中的一部分分裂到一个新的页中。

### 为什么要使用自增主键
在这里其实为什么进行节点分裂没有讲的太清楚。我自己把场景给补充出来了：
1. 自增插入，页里都是一个紧挨着一个插入，如果页满了就会新建一个页去插入数据。
2. 不自增插入，这时候内部的页的数据都是留有空隙的，如果页满了会讲此时页内的一部分给分到新建的页中。

### 什么时候使用自增主键

引入一个身份证的场景，都知道身份证是唯一确认的，那么他就可以用来作为索引。可是真的应该用它来做主键索引吗？
从两个角度思考：
- 主键长度：主键长度长，那么主键的指针占用的空间就会更大，那么最终会导致B+树变高，一个页内可以放的数据，查询效率变低。
- 是否自增：自增索引就不会导致节点分裂，那么即会提高页的使用效率

### 什么时候可以不使用自增主键

KV数据的场景，现在看来就是Redis的使用场景，当你只需要存储一个key的时候，就无所谓什么自增不自增了。

## 总结
上部分主要讲了索引的选型，为什么要用这样的索引。以及在使用的时候的自增索引的注意事项。