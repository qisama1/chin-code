# 常见主从面试题

## 1.redis主从节点是长连接还是短连接
长连接，要去后续的增量复制

## 2.怎么判断redis某个节点是否正常工作
互相的ping-pong心跳检测机制，如果有一半的节点去ping一个节点时pong没有反馈，那么集群就会认为这个节点宕机，会断开掉这个节点的连接。

redis主节点默认10s发一次心跳
redis从节点每隔1s发送一次心跳，给主节点发送自己的offset，获取最新的数据，并且判断主节点是否在线。

## 3. 过期key怎么处理
主节点处理了一个key或者淘汰了一个key以后，主节点模拟一条key命令给从节点，从节点这时删除key

## redis是同步复制还是异步复制
异步

redis主节点收到每次的写命令以后，写到内部的缓冲区，然后再异步复制给从节点。

## redis主从切换以后的数据缺失

### 异步复制同步丢失
当主节点处理好写请求，写缓冲区。但是没来得及异步发送给slave节点了，就宕机了，也没同步到磁盘。这时候就会丢失数据。

解决：
1. master出问题了，client端采取降级措施，先给数据写入本地换粗和磁盘，过段时间再重新写到redis上去
2. mq消息队列处理去写master 

### 集群产生脑裂问题
#### 怎么产生的脑裂
当有sentinel哨兵在监听的时候，发现一个master因为网络原因挂掉了，这时候哨兵进行选举，选出一个新的master。

但是呢之前的这个master并没有死透，只是和其他的节点的网络出现了问题，那么有的client它的不知道的，继续往master去写数据。

那么此时就出问题了，两个master里面的数据不一样。再之后，sentinel会把这个之前的master设置为sliver，在这时候它会删除自己本地的数据，进行一次全量的同步。那么之前写的数据都全部消失了。
#### 解决方案
1. min-slaves-to-write 2
2. min-slaves-max-lag 5

表示至少有2个slave与master的同步复制延迟不能超过5s，一旦所有的slave复制和同步延迟达到了5s，那么master就不会接收请求。

这样子就可以防止脑裂产生的数据不一致。

## redis如何故障自动切换
如果没有sentinel，是需要人工干预的，并且这时候redis无法接受写请求，是不可用的。

### sentinel哨兵
哨兵集群是在redis的master节点出问题了，然后自动发现它，再去选举去新的master，并且可以通知client方。