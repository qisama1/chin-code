# 服务发现

## 为什么需要服务发现
我们发送请求就像打电话一样，需要知道对方的电话号码才行。发送请求则需要知道对方的IP地址。

同时网络是在不断变化的，我们需要及时的得知服务提供方的IP，那么就需要一个服务发现系统。

## DNS为什么不行
作为HTTP的老朋友，DNS就是HTTP的服务发现的帮手。广而用之的DNS有个无法选用的弊端就是及时性，DNS为了减少服务的压力，采用了多级缓存，一般缓存的时间都很长。那么：
1. 服务上线我们无法及时感知
2. 服务下限我们同样无法及时感知

这样来看其实DNS有着极强的AP。

## ZK
ZK作为Dubbo使用的服务发现中间件，那么他的优势就是很简单：
1. 服务平台管理端在ZK中创建一个服务的根路径，分别创建一个如/service/com.demo.xxService的目录。在为其创建提供方和调用方的目录（consumer， provider）
2. 发起注册时，会为服务提供方目录中创建一个临时节点，存储服务提供方的注册信息
3. 发起订阅的时候，就在服务调用方的目录中创建一个临时节点，节点中存储该服务调用方的信息，同时watch该服务的服务提供方的目录中所有的服务节点的数据。
4. 如果发生变更，就会发起通知给所有订阅的节点。

缺点：
ZK保持了强一致性是一个CP的，那么它就无法做到A。当有大量的节点同时上线的时候，会占用十分多的CPU资源，导致ZK宕机。

## 消息总线

消息总线也就是AP的一个模型。

分为多个注册中心节点和一个消息总线。当某一个节点收到了注册消息/关闭消息，会将信息同步到消息总线。消息总线再主动推送到每个注册中心。同时注册中心也会从消息总线拉取消息。对于获取到的版本，会通过和本地的版本号对比，只接受版本号更大的更新。

消费者可以从任意一节点中获取信息。当然会出现新服务未及时同步，下线服务未更新（在框架内进行判断，如果调用的服务不存在或者下线，就会拒绝这个请求并转到其他服务）。

为了系统的健壮性，而舍弃强一致性。

## 灰度发布和屏蔽某些节点

### 屏蔽某些节点
想要屏蔽某些节点就可以使用负载均衡，把一些想屏蔽的节点的权值设置为0即可。

### 灰度发布
类似于上述，将灰度节点标记为grey，普通节点标记为normal。面对此类灰度请求就可以筛选找到响应的服务提供者。